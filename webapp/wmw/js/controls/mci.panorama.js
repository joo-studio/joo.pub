/**
* h5player v0.0.1 by yangyin 
* Copyright 2014 yangyin@mcitech.cn http://weibo.com/nodersolar
*/
!function(a){"function"==typeof define&&define.amd?define("mci.panorama",["jquery","mci.support"],a):a(jQuery,Support,THREE)}(function(a,b,c){"use strict";function d(a,b){return e?a.changedTouches[0][b]:a[b]}var e=b.touch,f=b.touchStartEvent,g=b.touchMoveEvent,h=b.touchEndEvent,i=function(a){return this instanceof i?this.init(a):new i(a)};return i.prototype.init=function(b){var c=this;if(c.options=c.options||{width:0,height:0,fullscreen:!0},c.options=a.extend(c.options,b),!c.options.dom)throw"setting dom can't be null or undefine";c.dom=c.options.dom,c.showing=!1,c.options.fullscreen?c.dom[0].addEventListener("click",c,!1):c.startShow()},i.prototype.handleEvent=function(a){var b=this;switch(a.type){case f:b._touchStart(a);break;case g:b._touchMove(a);break;case h:b._touchEnd(a);break;case"click":b._click(a)}},i.prototype._touchStart=function(a){var b=this;a.preventDefault(),b.isUserInteracting=!0,b.onPointerDownPointerX=d(a,"pageX"),b.onPointerDownPointerY=d(a,"pageY"),b.onPointerDownLon=b.point.lon,b.onPointerDownLat=b.point.lat},i.prototype._touchMove=function(a){var b=this;a.preventDefault(),a.stopPropagation(),b.isUserInteracting&&(b.point.lon=.1*(b.onPointerDownPointerX-d(a,"pageX"))+b.onPointerDownLon,b.point.lat=.1*(d(a,"pageY")-b.onPointerDownPointerY)+b.onPointerDownLat,b.render())},i.prototype._touchEnd=function(){var a=this;a.isUserInteracting=!1,a.render()},i.prototype._click=function(a){var b=this;a.preventDefault(),a.stopPropagation(),b.startShow()},i.prototype._loadMaterial=function(a){var b=this,d=new c.Texture(b.viewElement),e=new c.MeshBasicMaterial({map:d,overdraw:!0}),f=new Image;return f.onload=function(){d.needsUpdate=!0,e.map.image=this,b.render()},f.src=a,e},i.prototype._loadMaterial$Dom=function(b){var d=this,e=a(b).find("> img");if(!(e.length>=2))return d._loadMaterial(e[0].src);var f=new c.Texture(d.viewElement),g=new c.MeshBasicMaterial({map:f,overdraw:!0}),h=new Image;h.onload=function(){f.needsUpdate=!0,g.map.image=this,d.render()};var i=document.createElement("canvas");i.width=d.options.width,i.height=d.options.height;var j=i.getContext("2d"),k=function(b){if(!(b>=e.length)){var c=e[b],d=(a(c).parent(),parseInt(a(c).css("top"))||0),f=parseInt(a(c).css("left"))||0,g=parseInt(a(c).width()),l=parseInt(a(c).height()),m=new Image;m.src=a(c).attr("src"),m.onload=function(){j.drawImage(m,f,d,g,l);var a=i.toDataURL();h.src=a,k(b+1)}}};return k(0),g},i.prototype.render=function(){var a=this;a.point.lat=Math.max(-85,Math.min(85,a.point.lat)),a.point.phi=(90-a.point.lat)*Math.PI/180;var b=a.point.lon*Math.PI/180;a.target.x=500*Math.sin(a.point.phi)*Math.cos(b),a.target.y=500*Math.cos(a.point.phi),a.target.z=500*Math.sin(a.point.phi)*Math.sin(b),a.camera.lookAt(a.target),a.renderer.render(a.scene,a.camera)},i.prototype.startShow=function(){var d=this;if(!d.showing){var e=window.pageWidth||window.innerWidth,i=window.pageHeight||window.innerHeight;d.options.fullscreen?(d.container=a('<div id="panorama_fullscreen"><div class="close"></div></div>').appendTo(a("body")),d.container.css({position:"absolute",top:""+i+"px",left:"0","z-index":"9999",transform:b.transform3d?"translate3d(0,0,0)":"translate(0,0)"}),d.container.find(">.close").on("click",function(){d.close()}),setTimeout(function(){d.showing=!0,d.container.css({transition:b.getCSSVal("transform")+" 350ms ease",transform:b.transform3d?"translate3d(0,-"+i+"px,0)":"translate(0,-"+i+"px)"})},80)):d.container=d.dom.find(">.mci-panorama-i >.mci-panorama-con"),d.viewElement=document.createElement("canvas"),d.viewElement.width=0==d.options.width?e:d.options.width,d.viewElement.height=0==d.options.height?i:d.options.height;var j=d.viewElement.getContext("2d");j.fillStyle="rgb(200,200,200)",j.fillRect(0,0,d.viewElement.width,d.viewElement.height),d.camera=new c.PerspectiveCamera(75,e/i,1,1100),d.scene=new c.Scene,d.scene.add(d.camera),d.target=new c.Vector3;var k=d.dom.find(">.mci-panorama-i >.mci-panorama-pic");d.point={lon:90,lat:0,phi:0};var l=[d._loadMaterial$Dom(k[3]),d._loadMaterial$Dom(k[2]),d._loadMaterial$Dom(k[4]),d._loadMaterial$Dom(k[5]),d._loadMaterial$Dom(k[1]),d._loadMaterial$Dom(k[0])];d.mesh=new c.Mesh(new c.CubeGeometry(300,300,300,7,7,7,l),new c.MeshFaceMaterial),d.mesh.scale.x=-1,d.scene.add(d.mesh),d.renderer=new c.CanvasRenderer,d.options.fullscreen?d.renderer.setSize(e,i):d.renderer.setSize(d.options.width,d.options.height),d.container.append(d.renderer.domElement);var m=null;m=d.options.fullscreen?d.container[0]:d.dom[0],m.addEventListener(f,d,!1),m.addEventListener(g,d,!1),m.addEventListener(h,d,!1)}},i.prototype.close=function(){var c=this;c.showing=!1,c.container.css({transition:b.getCSSVal("transform")+" 350ms ease",transform:b.transform3d?"translate3d(0,0,0)":"translate(0,0)"}),setTimeout(function(){a(c.container).remove()},350)},window.Panorama=i,i});