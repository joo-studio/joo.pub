/**
* h5player v0.0.1 by yangyin 
* Copyright 2014 yangyin@mcitech.cn http://weibo.com/nodersolar
*/
!function(a){"function"==typeof define&&define.amd?define("Magazine",["jquery","mci.bezier.animate","mci.slideshow","mci.button","mci.imagepan","mci.picture","mci.webbrowser","mci.video","mci.audio"],a):a(jQuery,MultiBezier,SlideShow,Button,ImagePan,Picture,WebBrowser,MciVideo,MciAudio)}(function($,MultiBezier,SlideShow,Button,ImagePan,Picture,WebBrowser,MciVideo,MciAudio){"use strict";var Magazine=function(a){return this instanceof Magazine?this.init(a):new Magazine(a)};return Magazine.prototype.init=function(){var a=this;a.options=a.options||{},a.childList=[],a._eventList=[],a._bodyTag=1,$("body").click(function(){a._bodyTag=1==a._bodyTag?0:1,$(a._eventList).each(function(){$.isFunction(this)&&this(a._bodyTag)})})},Magazine.prototype.addPage=function(a,b){var c=this,d={dom:a,pageIndex:b};c._initPage(d)},Magazine.prototype.removePage=function(a){var b=this,c=0;for(var d in b.childList){if(d.pageIndex==a){b.childList.splice(c,1);break}c++}},Magazine.prototype._initPage=function(a){var b=this;a.childList=[],$(a.dom).find(".item > article").each(function(){var c={};c.dom=this,b._initControls(c),a.childList.push(c)}),b.childList.push(a)},Magazine.prototype._initControls=function(a){var b=this;a.childList=[],a.objectList=[],b._initAnimate(a),b._initSlideShow(a),b._initButton(a),b._initImagePan(a),b._initPicture(a),b._initWebBrowser(a),b._initVideo(a),b._initAudio(a);for(var c=0;c<a.childList.length;c++){var d=a.childList[c],e=d.options.boundTargetId;if(""!=e){var f=$.inArray(e,a.objectList);if(f>-1){var g=a.childList[f];g&&(d.parentControl=g,g.childControl||(g.childControl=[]),d.nested=!0,g.childControl.push(d))}}}a.childControl=[];for(var c=0;c<a.childList.length;c++){var d=a.childList[c];d.nested||a.childControl.push(d)}},Magazine.prototype._initAnimate=function(section){var alist=$(section.dom).find("div[type='Animator']");alist.each(function(){var arrStr=$(this).attr("pathstr"),json=eval("("+arrStr+")");if(json.animateFinished=function(a){"gotoState"==a.actionType?$(section.childList).each(function(){return this._id==a.targetId?(this.goToState(a.targetRes),!0):void 0}):"play"==a.actionType?$(section.childList).each(function(){return this._id==a.targetId?(this instanceof SlideShow?$.isFunction(this.play)&&this.play():$.isFunction(this.start)&&this.start(!0),!0):void 0}):"hide"==a.actionType?$(section.childList).each(function(){return this._id==a.targetId?($.isFunction(this.hide)&&this.hide(),!0):void 0}):"stop"==a.actionType&&$(section.childList).each(function(){return this._id==a.targetId?($.isFunction(this.stop)&&this.stop(),!0):void 0})},json.syncMoving=function(a){$(section.childList).each(function(){if(this instanceof SlideShow||this instanceof MultiBezier){var b=this;this._id==a.syncTo&&""!=a.syncTo?(a.direction=1,b._syncMove(a)):this._id==a.syncFrom&&""!=a.syncFrom&&(a.direction=-1,b._syncMove(a))}})},json.syncMoveEnd=function(a){if(this instanceof SlideShow||this instanceof MultiBezier){var b=this;this._id==a.syncTo&&""!=a.syncTo?(a.direction=1,b._syncEnd(a)):this._id==a.syncFrom&&""!=a.syncFrom&&(a.direction=-1,b._syncEnd(a))}},json.data.length>0){json.$this=$(this);var mb=new MultiBezier(json);mb._id=$(this).attr("id"),section.childList.push(mb),section.objectList.push(mb._id)}})},Magazine.prototype._initSlideShow=function(section){var $items=$(section.dom).find(".mci-ss");$items.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{itemChanged:function(a){$(section.childList).each(function(){this instanceof Button?this.options.targetId==a.targetControlId&&(this.options.targetRes==a.fromId?1==this.selected&&this.setButtonSelected(!1):this.options.targetRes==a.toId&&0==this.selected&&this.setButtonSelected(!0)):this instanceof MultiBezier?this.options.boundTargetId==a.targetControlId&&this.options.boundTargetRes==a.fromId&&this.started&&(this.reset(),this.isRunning=!1):this instanceof MciAudio?this.options.boundTargetId==a.targetControlId&&this.options.boundTargetRes==a.fromId&&(this.stop(),this.isRunning=!1):this.options.boundTargetId==a.targetControlId&&this.options.boundTargetRes==a.fromId&&$.isFunction(this.reset)&&(this.reset(),this.isRunning=!1)})},syncMoving:function(a){$(section.childList).each(function(){if(this instanceof SlideShow||this instanceof MultiBezier){var b=this;this._id==a.syncTo&&""!=a.syncTo?(a.direction=1,b._syncMove(a)):this._id==a.syncFrom&&""!=a.syncFrom&&(a.direction=-1,b._syncMove(a))}})},syncMoveEnd:function(a){$(section.childList).each(function(){if(this instanceof SlideShow||this instanceof MultiBezier){var b=this;this._id==a.syncTo&&""!=a.syncTo?(a.direction=1,b._syncEnd(a)):this._id==a.syncFrom&&""!=a.syncFrom&&(a.direction=-1,b._syncEnd(a))}})},dom:$item}),ss=new SlideShow(op);ss._id=$item.attr("id"),section.childList.push(ss),section.objectList.push(ss._id)})},Magazine.prototype._initButton=function(section){var self=this,$buttons=$(section.dom).find(".mci-btn-w");$buttons.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item,gotoPage:function(a){var b=a.targetRes.split("#"),c=pageDict.indexOf(b[0]),d=void 0;2==b.length&&(d=parseInt(b[1])),-1!=c&&self.mcipage.jumpToPage(c,d)},gotoState:function(a){$(section.childList).each(function(){return this._id==a.targetId?(this.options.autoPlay&&clearInterval(this.loopHandler),this.goToState(1==a.selected?0:a.targetRes),!1):void 0})},play:function(a){$(section.childList).each(function(){return this._id==a.targetId?(this instanceof SlideShow?$.isFunction(this.play)&&this.play():$.isFunction(this.start)&&this.start(!0),!1):void 0})},stop:function(a){$(section.childList).each(function(){return this._id==a.targetId?($.isFunction(this.stop)&&this.stop(),!1):void 0})}}),btn=new Button(op);btn._id=$item.attr("id"),btn._parent=section,section.childList.push(btn),section.objectList.push(btn._id)})},Magazine.prototype._initImagePan=function(section){var self=this,$buttons=$(section.dom).find(".mci-imagepan");$buttons.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item}),imagePan=new ImagePan(op);imagePan._id=$item.attr("id"),section.childList.push(imagePan),section.objectList.push(imagePan._id)})},Magazine.prototype._initPicture=function(section){var self=this,$pictures=$(section.dom).find(".mci-picture-w");$pictures.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item}),pic=new Picture(op);pic._id=$item.attr("id"),section.childList.push(pic),section.objectList.push(pic._id)})},Magazine.prototype._initWebBrowser=function(section){var self=this,$webBrowsers=$(section.dom).find(".mci-wb-w");$webBrowsers.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item}),wb=new WebBrowser(op);wb._id=$item.attr("id"),section.childList.push(wb),section.objectList.push(wb._id)})},Magazine.prototype._initVideo=function(section){var self=this,$videos=$(section.dom).find(".mci-video-w");$videos.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item}),v=new MciVideo(op);v._id=$item.attr("id"),section.childList.push(v),section.objectList.push(v._id)})},Magazine.prototype._initAudio=function(section){var self=this,$audios=$(section.dom).find(".mci-audio-w");$audios.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item}),au=new MciAudio(op);au._id=$item.attr("id"),section.childList.push(au),section.objectList.push(au._id)})},Magazine.prototype._initPanorama=function(section){var self=this,$panoramas=$(section.dom).find(".mci-panorama-w");$panoramas.each(function(){var $item=$(this),op=$.extend(eval("("+$(this).attr("param")+")"),{dom:$item}),v=new Panorama(op);v._id=$item.attr("id"),section.childList.push(v),section.objectList.push(v._id)})},Magazine.prototype.start=function(a,b){var c=this;$(c.childList).each(function(){if(this.pageIndex==a){if(!this.childList||!this.childList[b])return;var c=this.childList[b].childControl,d=this.childList[b];0==$(d.dom).find(".loading").length&&$('<div class="loading" style="width:'+window.pageWidth+"px;height:"+window.pageHeight+'px;"><div class="mask-w"></div><span class="progress"><span class="r"></span></span></div>').appendTo(d.dom);var e=window.getScale();return $(d.dom).find(" .article-content").css({transform:"scale("+e.scale+","+e.scale+") translate3d("+e.left+"px,"+e.top+"px,0)"}),$(d.dom).loadSources(function(a,b){$(d.dom).find(" >.loading").find(".r").css({width:a/b*100+"%"})}).done(function(){$(d.dom).hasClass("loaded")||$(d.dom).addClass("loaded");for(var a in c)$.isFunction(c[a].start)&&(c[a].isRunning||(c[a].start(),c[a].isRunning=!0))}),!1}})},Magazine.prototype.addEvent=function(a){var b=this;b._eventList.push(a)},Magazine.prototype.initOverlayPage=function(a){var b=this,c={dom:a};return c.childList=[],$(c.dom).find(" article").each(function(){var a={};a.dom=this,b._initControls(a),c.childList.push(a);var d=window.getScale();$(c.dom).find(" .article-content").css({transform:"scale("+d.scale+","+d.scale+") translate3d("+d.left+"px,"+d.top+"px,0)"})}),c},Magazine.prototype.startOverlayPage=function(a){if(a&&a.childList.length>0){var b=a.childList[0].childControl,c=window.getScale();$(a.dom).find(" .article-content").css({transform:"scale("+c.scale+","+c.scale+") translate3d("+c.left+"px,"+c.top+"px,0)"});for(var d in b)$.isFunction(b[d].start)&&(b[d].isRunning||(b[d].start(),b[d].isRunning=!0))}},window.Magazine=Magazine,Magazine});